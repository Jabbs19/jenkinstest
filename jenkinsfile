def label = "jenkins-slave-${UUID.randomUUID().toString()}"
//def TAIL_TAG = ""
//def HEAD_TAG = ""

podTemplate(
    label: label,
    cloud: "openshift",
    containers: [
        containerTemplate(name: 'maven', image: 'maven:alpine', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'golang', image: 'golang:alpine', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'helm', image: 'docker-registry.default.svc:5000/openshift/helm:2.14.0', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'openshift', image: 'docker-registry.default.svc:5000/openshift/openshift-cli', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'docker', image: 'docker', ttyEnabled: true, command: 'cat'),
		containerTemplate(name: 'ruby', image: 'ruby:2.5.5', ttyEnabled: true, command: 'cat')

    
    ]
) {
    node(label) {
        stage('Init') {
          sh """
            pwd
            env
            find ${HOME}
            df -h
            """
        }
        stage('Checkout') {
            container('jnlp') {
                checkout scm
                def TAIL_TAG = sh(returnStdout: true, script: "git tag --sort version:refname | tail -1").trim()
                echo 'Tail Tag:'
                echo TAIL_TAG
                def COMMIT_HEAD_TAG = sh(returnStdout: true, script: "git tag -l --points-at HEAD | tail -1").trim()
                echo 'Head Tag:'
                echo COMMIT_HEAD_TAG
                if (env.BRANCH_NAME == 'master') {
                    echo 'Executing on Master'
                } else if (env.BRANCH_NAME == 'develop'){
                    echo 'Execute Unit Tests on Develop'
                    sh 'ruby -v'

                } else if (env.BRANCH_NAME == 'release'){
                    echo 'Execute Unit on Tag?'
                    sh 'ruby -v'

                } else if (env.BRANCH_NAME.contains('prod') && COMMIT_HEAD_TAG.contains('prod')){
                    echo 'This is the "prod" specific tag release.'
                    
                }
                else {
                    echo 'Head Tag:'    
                    echo COMMIT_HEAD_TAG
                    echo 'Env:'
                    echo env.BRANCH_NAME
                    echo 'This is the fallback of this IF'
                }
                // try {
                // def MASTER_TAG = sh(returnStdout: true, script: "git tag -l --points-at=master").trim()
                // echo 'Master Tag:'
                // echo MASTER_TAG
                // } catch (e) {
                // }
                // finally {
                // }

               


            }
        }

        // stage('Unit Test') {
        //     container('ruby') {
        //         echo 'Branch:'
        //         echo env.BRANCH_NAME
        //         echo 'Tag:'
                
        //         echo 'Start Branch Decision'
        //         if (env.BRANCH_NAME == 'master') {
        //             echo 'Execute Unit Tests on Master'
        //         } else if (env.BRANCH_NAME == 'develop'){
        //             echo 'Execute Unit Tests on Develop'
        //             sh 'ruby -v'

        //         } else if (env.BRANCH_NAME == ''){
        //             echo 'Execute Unit on Tag?'
        //             sh 'ruby -v'

        //         } else {
        //             echo 'I execute elsewhere'
        //         }
                
        //     }
        // }
		
        // stage('OC Build Image') {
        //     container('openshift') {
        //         sh 'oc whoami'
        //     }
        // }
		
        // stage('package charts') {
        //     container('helm') {
        //         sh 'helm help'
        //     }
        // }
    	
        // stage('Deploy') {
        //     echo env.GIT_TAG_NAME
        //     if (env.BRANCH_NAME == 'master') {
        //         echo 'I only execute on the master branch'
                
                

        //     } else if (env.BRANCH_NAME == 'develop'){
        //         echo 'I only execute on the develop branch'
        //         echo env.GIT_TAG_NAME
        //     }

        //     else {
        //         echo 'I execute elsewhere'
        //     }
        // }
        // stage('Checkout') {
        //     container('jnlp') {
        //         checkout scm
        //     }
        // }
        
        
    }
}
