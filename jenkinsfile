def label = "jenkins-slave-${UUID.randomUUID().toString()}"

podTemplate(
    label: label,
    cloud: "openshift",
    containers: [
        containerTemplate(name: 'maven', image: 'maven:alpine', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'golang', image: 'golang:alpine', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'helm', image: 'docker-registry.default.svc:5000/openshift/helm:2.14.0', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'openshift', image: 'docker-registry.default.svc:5000/openshift/openshift-cli', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'docker', image: 'docker', ttyEnabled: true, command: 'cat'),
		containerTemplate(name: 'ruby', image: 'ruby:2.5.5', ttyEnabled: true, command: 'cat')

    
    ]
) {
    node(label) {
        stage('Init') {
          sh """
            pwd
            env
            find ${HOME}
            df -h
	    echo 'itsworking'
            """
	    
	}
        stage('Checkout') {
            container('maven') {
                checkout scm
		//script{ datas = readYaml (file: 'manifest.yml') }
            	//echo datas.ear_file.deploy.toString()
	    
	    
	    def chartYaml = readYaml file: 'jenkinstest/Chart.yaml'
	    def chartVersion = chartYaml.version.toString()
	    if (chartVersion == "0.1.0") {
              //Failed to parse yaml?  Fail push??  Parse some other way.
	      echo 'chartversion matched'
            }
	    sh """
	    echo ${chartVersion}
	    """
	    
	    def valuesYaml = readYaml file: 'jenkinstest/values.yaml'
	    valuesYaml.image.tag = 'marktest'
            sh "rm -f jenkinstest/values.yaml"
            writeYaml file: "jenkinstest/values.yaml", data: valuesYaml
	  
           
	    def newValuesYaml = readYaml file: 'jenkinstest/values.yaml'
	    def newTag = newValuesYaml.image.tag.toString()
	    sh """
	    echo ${newTag}
	    """
	    
	   sh """
	    echo 'end of echos'
	    """
	    }
        }
	container('openshift') {
            stage('OC Build Image') {
                sh 'oc whoami'
				//sh "oc start-build ${APP_NAME} --from-dir=./_site/ --wait --follow"
	    }
	   stage('OC Deploy to Stage') {
                sh 'oc login -u cluster-admin -p password https://lb.aheadaviation.local:8443 --insecure-skip-tls-verify'
                sh 'oc project shared-services'
                sh 'oc get pods'
                }
	 }
    	
	container('helm') {
            stage('package charts') {
                sh 'helm help'
            }
        }
        container('ruby') {
            stage('More tests') {
                sh 'ruby -v'
            }
        }
        
        
    }
}
